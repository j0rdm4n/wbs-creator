<!DOCTYPE html>
<html>

<link rel="stylesheet" type="text/css" href="reset.css"/>
<link rel="stylesheet" type="text/css" href="style.css"/>

<script type="text/javascript" src="jquery.min.js"></script>

<script type="text/javascript" src="host-vars.js.jsp"></script>

<script type="text/javascript">
	var model;
	var sheetId;
	var username;
	var projectId;
	
	var syncUpdateTaskWithServer = function(task) {
		$.ajax({type: 'PUT', url: host + 'task',
			data: {'taskId': task.taskId, effort: task.effort, name: task.name}});
	}
	
	var syncNewTaskWithServer = function(parentTask, newTask) {
			$.ajax({type: 'POST', url: host + 'task',
				data: {'parentTaskId': parentTask.taskId} }).complete(function(xhr, data) {
					var response = xhr.getResponseHeader('location');
					var last = response.split('\/');
					
					newTask.taskId = last[last.length - 1];
				});			
	}
	
	var syncDeleteTaskWithServer = function(taskId) {
		$.ajax({type: 'DELETE', url: host + 'task',
			data: {'taskId': taskId}});
	}
	
	var createTaskDetail = function(taskDetail, level, addSibblingFunction, addChildFunction, deleteTaskFunction) {
		var template = 
			'<div class="task-detail">' +
				'<button class="done">OK</button>' + 
				'<div class="trunk-mask"></div>' +
				'<div class="mask-right"></div>' +
				'<div class="add-sibbling">+</div>' +
				'<div class="add-child">+</div>' + 
				'<div class="del-task">-</div>';			
			
			if (level > 2) {
				template = template + 
					'	<div class="line"></div>';
			} else if (level == 1) {
				template = template + 
					'	<div class="bottomline"></div>';
			} else if (level == 2) {
				template = template +
					'<div class="topline"></div>';
			}			
			
			template = template + 
			'	<div class="name"><input type="text"></input><span></span></div>' + 
			' <div class="effort"><input type="text"></input><span></span></div>' + 
			'	<div class="number"></div>' +
			'</div>';
		
		template = $(template);
		
		$('div.add-sibbling', template).click(function() {
			addSibblingFunction();
			draw();
		});
		$('div.add-child', template).click(function() {
			addChildFunction();
			draw();
		});
		$('div.del-task', template).click(function() {
			deleteTaskFunction();
			
			syncDeleteTaskWithServer(taskDetail.taskId);
			
			draw();
		});
		
		$('.name span', template).html(taskDetail.name);
  	$('.effort span', template).html(taskDetail.effort);
		$('.number', template).html(taskDetail.number);
		
		$(template).click(function() {
			if($(template).hasClass('editing')) {
				return;
			}
		
			$(template).addClass('editing');
			
			$('.effort input', template).val(taskDetail.effort);			
			$('.name input', template).val(taskDetail.name);			
		});
		
		$('button', template).click(function() {
			taskDetail.effort = parseInt($('.effort input', template).val());
			taskDetail.name = $('.name input', template).val();
			
			syncUpdateTaskWithServer(taskDetail);
			
			draw();
		});
		
		return template;
	};
	
	var createSubTask = function(subTask, last, sibblings, parent) {
		var i;
		var template = '<div class="task subtask">' +
			'<div class="trunk">' +
			'<div class="trunk-erase">' +
			'</div>' +			
			'<div class="trunk-outer-erase"></div>' +     
		'</div>';
				
		var result = $(template);
		result.prepend(createTaskDetail(subTask, 2, null, function() {
			var task = {
						name: 'website',
						effort: '0'
			};
			
			syncNewTaskWithServer(subTask, task);
		
			if (!subTask.subTasks) {
				subTask.subTasks = [];				
			}
			
			subTask.subTasks.push(task);
			
			draw();
		},
			function() {
				var idx = sibblings.indexOf(subTask);
				sibblings.splice(idx, idx);
			
			}));
		
		if (last) {
			$(result).addClass('last-task');
		}
		
		for(i in subTask.subTasks) {
			$('> .trunk', result).append(createSubSubTask(subTask.subTasks[i], subTask.subTasks, subTask));
		}
		
		if (!subTask.subTasks || subTask.subTasks.length == 0) {
			$('.trunk', result).hide();
		}
			
		return result;
	}
	
	var createSubSubTask = function(subSubTask, sibblings, parent) {
		var template = '<div class="task subsubtask">' +
			'</div>';
			
		template = $(template);
		
		if (sibblings[sibblings.length - 1] === subSubTask) {
			template.addClass("task-last");
		}
		
		template.append(createTaskDetail(subSubTask, 3, function() {
				var task = {
					name: '',
					effort: '0'
				};
				sibblings.push(task);
				
				syncNewTaskWithServer(parent, task);
					
					draw();
			}, function() {
				var task = {
							name: '',
							effort: '0'
				}
			
				if (!subSubTask.subTasks) {
					subSubTask.subTasks = [];
				}
				
				subSubTask.subTasks.push(task);
				
				syncNewTaskWithServer(subSubTask, task);
				
				draw();
				
			}, function() {
				var j = sibblings.indexOf(subSubTask);
				
				sibblings.splice(j, 1);							
			}));
			
			if (subSubTask.subTasks && subSubTask.subTasks.length > 0) {		
				template.append($(
					'<div class="trunk">' +
  	      	'<div class="trunk-erase"></div>' + 
  	      	'<div class="trunk-outer-erase"></div>' +                                 
  	      '</div>'));
  	      
  	    var i;
  	    for(i in subSubTask.subTasks) {
  	    	$('> .trunk', template).append(createSubSubTask(subSubTask.subTasks[i], subSubTask.subTasks, subSubTask));
  	    }
			}
			
		 return template;
	}
	
	var calcTotals = function(task) {
		var total = 0;
		var i;
		
		if (task.subTasks && task.subTasks.length != 0) {
			for (i in task.subTasks) {
				total += calcTotals(task.subTasks[i]);
			}
		} else {
			total = parseInt(task.effort);
		}
		
		task.effort = total;
		
		return total;
	}
	
	var calcLabel = function(task, prefix) {
		task.number = prefix;
		var i;
		
		if (task.subTasks) {
			for(i = 0; i < task.subTasks.length; i++) {
				calcLabel(task.subTasks[i], prefix + "." + (i + 1));			
			}
		}
	}
	
	var draw = function() {
		var i;
		
		calcTotals(model);
		calcLabel(model, "1");
		
		$('.root').html('');
		
		$('.root').append($('<div class="vertical-line">' +
      	'<div class="mask-left"></div>' +
      '</div>'));
	
		$('.root').prepend(createTaskDetail(model, 1, null, function() {
					var task = { 
							name: '',
							effort: '0'
					};
					
					syncNewTaskWithServer(model, task);
		
					model.subTasks.push(task);
					
					draw();
		}));
		
		for(i in model.subTasks) {		
		
			$('.root').append(createSubTask(model.subTasks[i], i == model.subTasks.length - 1, model.subTasks, model));
		}
	};
	
	$(document).ready(function() {
		$('#dialog-username').show();	
		
		$('#register').click(function() {
			$.ajax({type: 'POST', url: host + 'user',
				data: {'username': $('#username').val(), 'password': $('#password').val(), email: $('#password').val()}}).success(
					function() {
						username = $('username');							
					});			
		});
		
		$('#login').click(function() {
			username = $('#username-existing').val();
			
			$('#dialog-username').hide();
			$('#dialog-project').show();
			
			showProjects();
		});
		
		$('#create-project').click(function() {
			$.ajax({type: 'POST', url: host + 'project',
				data: {'username': username, 'projectName': $('#project-name').val() }
		}).success(showProjects);
		});
		
		$('#create-sheet').click(function() {
			$.ajax({type: 'POST', url: host + 'sheet',
				data: {'sheetName': $('#sheet-name').val(), 'projectId': projectId }
		}).success(showSheets);
		
		});
		
		var showProjects = function() {
				$.ajax({type: 'GET', url: host + 'user/' + username}).success(function(data) {
					$('#list-projects tbody').html('');
					$.each(data, function(i, project) {
						var template = '<tr><td class="link"></td></tr>';
						template = $(template);
						$('.link', template).html(project.name);
						$('.link', template).click(function() {
							projectId = project.projectId;

							$('#dialog-project').hide();
							$('#dialog-sheet').show();
														
							showSheets();						
							updateMembers(project);
						});
						$('#list-projects tbody').append(template);
				}); 
			});
		};
		
		var showSheets = function() {
			$('#dialog-members').show();
						
			$.ajax({type: 'GET', url: host + 'project/' + projectId}).success(function(data) {
					$('#list-sheets tbody').html('');
				
					$.each(data, function(i, sheet) {
						var template = '<tr><td class="link"></td></tr>';
						template = $(template);
						$('.link', template).html(sheet.name);
						$('.link', template).click(function() {
							sheetId = sheet.sheetId;
							
							$('#dialog-sheet').hide();
							$('.dialog').hide();
							getTaskModel();
							$('#dialog-share').show();
						});
						$('#list-sheets tbody').append(template);
				}); 
		});
		};
		
		$('#generate-share').click(function() {
		$.ajax({url: host + "sheet/public", type: 'POST', data: { 'sheetId': sheetId }}).complete(function(xhr, data) {
					var response = xhr.getResponseHeader('location');
					var last = response.split('\/');
					last = last[last.length - 1];
					
					$('#publicUrl').val(window.location + "#publicSecret=" + last);
		});
	});
	
		var url = window.location.toString();
	
		var idx = url.indexOf('publicSecret');

		if (idx != -1) {
			var publicSecret = url.substring(idx).replace("publicSecret=", "");

								
			$.ajax({url: host + 'sheet/public/' + publicSecret}).done(function(data) {
				model = data.root;
				
				$('.dialog').hide();
				draw();
				
				
			});
		}
		
	
	});
	
	
	var updateMembers = function(sheet) {
		$('#dialog-members tbody').html('');
		
		$('#add-member').click(function() {

			$.ajax({url: host + 'project/' + projectId + '/members/' + $('#member-username').val(),
				type: 'POST'});
		});
		
		if (!sheet.members) {
			return;
		}
		
		$.each(sheet.members, function(i, member) {
			var template = '<tr><td class="username"></td></tr>';
			template = $(template);
			
			$('.username', template).html(member.username);			
			$('#dialog-members tbody').append(template);			
		});		
	}
		
	var getTaskModel = function() {		
		
	
		$.ajax({url: host + 'sheet/' + sheetId})
			.done(function(data) {
				model = data.root;
				
				draw();
			});
		}
</script>

<body>
<div class="dialog" id="dialog-username">
	<div class="unit size12">
	<label>Username</label>
	<input type="text" id="username"/>

	<label>Email</label>
	<input type="text" id="email"/>

	<label>Password</label>
	<input type="text" id="password"/>
	
	<div><button id="register">Register</button></div>
	</div>
	
	<div class="unit size12">
	<label>Existing</label>
	<input type="text" id="username-existing"/>
	
		<div><button id="login">Login</button></div>
	</div>
	
</div>

<div class="dialog" id="dialog-sheet">

	<table id="list-sheets">
		<tr><td>Name</td></tr>
	</table>

	<label>Sheet</label>
	<input type="text" id="sheet-name"/>
	
	<div><button id="create-sheet">Create sheet</button></div>
</div>

<div class="dialog" id="dialog-project">
	<table id="list-projects">
		<tr><td>Name</td></tr>
	</table>

	<label>Project</label>
	<input type="text" id="project-name"/>
	
	<div><button id="create-project">Create project</button></div>
</div>

<div class="dialog" id="dialog-members">
	<table id="list-members">
		<tr><td>Name</td></tr>
	</table>
	
	<label>Username</label>
	<input type="text" id="member-username"/>

	<div><button id="add-member">Add member</button></div>	
</div>

<div class="dialog" id="dialog-share">
	<button id="generate-share">Share this sheet</button>
	<textarea id="publicUrl"></textarea>
</div>

<div class="inner">
	<div class="root">
			
	</div>
</div>

</body>
</html>
